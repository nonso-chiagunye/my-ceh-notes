MODULE 07: MALWARE THREATS

1. Gain access to the target system using Trojans

a. Gain control over a victim machine using the njRAT RAT Trojan

PS: njRAT is a RAT with powerful data-stealing capabilities. In addition to logging keystrokes, it is capable of accessing a victim’s camera, stealing credentials stored in browsers, uploading and downloading files, performing process and file manipulations, and viewing the victim’s desktop.

Step 1: Create and Share the Trojan (.11)

Windows 11 (Host) -> njRat v0.7d.exe -> Port (5552) -> Start -> Builder -> IP (Host) -> Registry Startup -> Build -> Save As (xyz.exe) -> Copy/Paste on CEH-Tools

Step 2: Run the Trojan on Victim Machine (.22)

Server 2022 (Victim) -> CEH-Tools (xyz.exe)

Step 3: Manipulate Victim Machine from Host (.11)

Host -> Right-click Server Name -> Manager -> Process manager etc
Connections -> Right-click a connection -> Kill
Registry
Remote Shell

Right-click Name -> RDP -> Mouse (remotely interact with victim with Mouse) 
Right-click Name -> Open Chat -> Ok -> 

Step 4: To remove on Victim Machine (.22)

Task Manager -> More details -> server.exe (32 bit) (End Task) 








b. Hide a Trojan using SwayzCryptor and make it undetectable to various anti-virus programs

PS: One method that attackers use to bypass AVs is to “crypt” (an abbreviation of “encrypt”) the malicious files using fully undetectable crypters (FUDs).

SwayzCryptor is an encrypter (or “crypter”) that allows users to encrypt their program’s source code.

Step 1: Check How Many AntiVirus Vendors Detect Malware

https://www.virustotal.com -> Choose File -> attacker.exe -> Confirm upload -> 60/71 Vendors flagged as malicious.

Step 2: Crypt Malware to make it Undetectable 

E:\..\SwayzCryptor double-click SwayzCraptor.exe -> File (Select Malware File) -> Start up, Mutex, Disable UAC -> Encrypt -> Save (Leave Default FileName) 

Step 3: Check Again to See How many Vendors Will Detect.

Try Again on Virus Total. Only a few AV will detect it.
Send it to victim and start njRAT again, it will still establish connection like before.






c. Create a Trojan server using Theef RAT Trojan

Theef is a Remote Access Trojan written in Delphi. It allows remote attackers access to the system via port 9871

Step 1: Start the Server on Victim Machine

Victim Machine -> Z:\..\Theef -> Double-click Server210.exe

Step 2: Start the Client on Attacker/Host Machine 

Host -> E:\..\Theef -> Double-click Client210.exe -> IP (Victim) -> Connect -> 






2. Infect the target system using a virus

a. Create a virus using the JPS Virus Maker Tool and infect the target system

PS: The JPS Virus Maker tool is used to create its own customized virus.

PS: This tool has many options for building that can be used to create a virus. Some of the tool’s features are auto-start, shutdown, disable security center, lock mouse and keyboard, destroy protected storage, and terminate windows. 

PS: An ethical hacker and pen-tester can use the JPS Virus Maker Tool as a proof of concept to audit perimeter security controls in an organization.

E:\..\JPS Virus Maker double-click jps.exe -> Check: Disable TaskManager etc.
When done, virus is saved at same location with JPS Virus Maker - filename Server.








3. Perform static malware analysis

Malware analysis provides an in-depth understanding of each individual sample and identifies emerging technology trends from large collections of malware samples without executing them. 

The samples of malware are mostly compatible with the Windows binary executable

By performing malware analysis, detailed information regarding the malware can be extracted. This information includes items like the malicious intent of the malware, indicators of compromise, complexity level of the intruder, exploited vulnerability, extent of damage caused by the intrusion, perpetrator accountable for installing the malware, and system vulnerability the malware has exploited.

Some of the static malware analysis techniques are:

- File fingerprinting
- Local and online malware scanning
- Performing strings search
- Identifying packing and obfuscation methods
- Finding portable executable (PE) information
- Identifying file dependencies
- Malware disassembly





a. Perform malware scanning using Hybrid Analysis

https://www.hybrid-analysis.com -> Drag and Drop for Instant Analysis -> E:\..\Viruses -> tini.exe -> email -> Windows 7 64 bit -> Generate Public Report -> Shows malicious with Threat Score -> Visit Vendor (to visit any of the AV report).






b. Perform a strings search using BinText

PS: Various strings that could represent the malicious intent of a program such as reading the internal memory or cookie data, are embedded in the compiled binary code.

PS: Searching through strings can provide information about the basic functionality of any program. During malware analysis, search for malicious strings that could determine the harmful actions that a program can perform. For instance, if the program accesses a URL, it will have that URL string stored in it.

PS: BinText is a text extractor that can extract text from any file. It includes the ability to find plain ASCII text, Unicode text, and Resource strings, providing useful information for each item.

Double-click bintext -> Check: Advance View -> Browse(Choose virus) -> Go 







c. Identify packaging and obfuscation methods using PEid      (Windows Executable)

PS: Attackers often use packing and obfuscation or a packer to compress, encrypt, or modify a malware executable file to avoid detection. Obfuscation also hides the execution of the programs.

PS: The best approach is to try and identify if the file includes packed elements and locate the tool or method used to pack it.

PS: PEid is a free tool that provides details about Windows executable files. It can identify signatures associated with over 600 different packers and compilers. This tool also displays the type of packer used in packing a program.

Double-Click PEiD.exe -> Browse -> Open File.







d. Analyze ELF executable file using Detect It Easy (DIE)       (Linux Executable)

PS: The Executable and Linkable Format (ELF) is a generic executable file format in Linux environment.

PS: Detect It Easy (DIE) is an application used for determining the types of files. It detects a file’s compiler, linker, packer, etc. using a signature-based detection method.

Double-click die.exe -> Run -> File Name (Navigate to where virus is [Viruses - ELF Test File]) -> (Shows OS, Compiler -n8   and Language) -> File Info -> Entropy (Observer Status, Size and graph of Entropy). 








e. Find the portable executable (PE) information of a malware executable file using PE Explorer

Executable and Linkable Format (ELF) - Unix
Portable Executable Format (PE) - Windows

PS: The Portable Executable (PE) format is the executable file format used on Windows OSes that stores the information a Windows system requires to manage the executable code. The PE stores metadata about the program, which helps in finding additional details of the file. Consists of information such as time of creation and modification, import and export functions, compilation time, DLLs, and linked files, as well as strings, menus, and symbols.

PS: PE Explorer lets you open, view, and edit a variety of different 32-bit Windows executable file types (also called PE files) ranging from common such as EXE, DLL, and ActiveX Controls to less familiar types such as SCR (Screensavers), CPL (Control Panel Applets), SYS, MSSTYLES, BPL, DPL, and more (including executable files that run on MS Windows Mobile platform).

Double-click ..\PE Explorer (PE.Explorer_setup.exe) -> Uncheck view PE Exp Guide -> Check Launch ->  Finish -> File -> Open File -> ..\Viruses\Klez Virus Live (face.exe) Open -> Continue  (Headers Info Appears) -> Data Directories -> Section Headers (.text, .rdata, .data, .rsrc) -> Double-click any sectio to view content. 







f. Identify file dependencies using Dependency Walker

PS: Any software program depends on the various inbuilt libraries of an OS that help in performing specified actions in a system. Programs need to work with internal system files to function correctly. Programs store their import and export functions in a kernel32.dll file.

PS: Find the libraries and file dependencies, as they contain information about the run-time requirements of an application. Then, check to find and analyze these files to provide information about the malware in the file.

PS: Finding out all library functions may allow guessing about what the malware program can do. You should know the various DLLs used to load and run a program.


DLLs                     Description of Contents
Kernel32.dll		 Core functionality such as access and manipulation of memory, files, and hardware
Advapi32.dll		 Provides access to advanced core Windows components such as the service Manager and Rsgistry
User32.dll		 User-interface components such as buttons, scrollbars, and components for controlling and responding to                            user actions
Gidi32.dll		 Functions for displaying and manipulating graphics
Ntdll.dll		 Interface to the Windows Kernel
WSock32.dll and Ws2_32.dll Networking DLLs that help to connect to a network or perform network-related tasks
Wininet.dll		 Supports higher-level networking functions 

PS: The Dependency Walker tool lists all dependent modules of an executable file and builds hierarchical tree diagrams. It also records all functions that each module exports and calls.

Double-click .\File Dependency Checking Tools\Dependency Walker    depends.exe -> File -> Open -> .\Virus\Klez Virus Live  snoopy.exe -> Error: Ok -> Shrink .DLL Nodes -> Click any DLL (KERNEL32.DLL) 






g. Perform malware disassembly using IDA and OllyDbg

The primary purpose of a disassembler is to display the instructions actually executed by the processor in a symbolic representation called “assembly language.”

IDA As a disassembler: explores binary programs, for which the source code might not be available, to create maps of their execution.

OllyDbg is a debugger: 


g1. IDA

Search IDA -> IDA Freeware -> New -> ..\Viruz\klez.. face.exe -> Ok -> Right-click anywhere -> Text view -> Minimize IDA -> E:\..Disassembly and Debugging Tools\IDA copy qwingraph.exe -> Paste in C:\Programs files\IDA Freeware 7.7 -> Maximize IDA -> View -> Graphs -> Flow Chart -> Close after analysis -> View -> Graphs -> Function calls -> Close after analysis -> HexView-1 -> Structures -> Enum -> Close


g2. OllyDbg

E:\..\Disassembling and Debugging Tools\OllyDbg OLLYDBG.EXE -> File -> Open -> .\viruses  tini.exe -> View -> Log -> View -> Executable Modules -> Double-click any Module (73120000) -> View -> Memory -> View -> Threads





h. Perform malware disassembly using Ghidra

PS: Ghidra is a software reverse engineering (SRE) framework that includes a suite of full-featured, high-end software analysis tools that enable users to analyze compiled code on a variety of platforms including Windows, MacOS, and Linux.

\..\Disassembly and Debugging Tools\Ghidra   ghidraRun.bat -> in a Command Prompt: C:\Program Files\jdk-17.0.2+8 -> Tips of the day: Close -> File -> New Project -> Non-Shared Project: Next -> Enter Project Name: Malware Analysis -> Finish -> File -> Import File -> ..\Viruses\Klez..  face.exe -> Select File to Import -> Ok -> Import Result Summary:Ok -> (face.exe is added as Children node under Malware Analysis project -> double-click Face.exe -> Analyze (Pop-up): Yes -> Analyze -> Symbol Tree: Import (view DLL files) -> Close Decompiler -> Program Tree: double-click Headers -> double-click .rdata -> 









4. Perform dynamic malware analysis

PS: Dynamic analysis is performed to gather valuable information about malware activity, including the files and folders created, ports and URLs accessed, called functions and libraries, applications and tools accessed, information transferred, settings modified processes, and services the malware started, and other items. 

To achieve this, you need to perform the following:

- System Baselining:  A system baseline involves recording details of the file system, registry, open ports, network activity, and other items.
- Host Integrity Monitoring: Host integrity monitoring is the process of studying the changes that have taken place across a system or a machine after a series of actions or incidents.

Host integrity monitoring includes:

	. Port monitoring
	. Process monitoring
	. Registry monitoring
	. Windows services monitoring
	. Startup program monitoring
	. Event logs monitoring and analysis
	. Installation monitoring
	. Files and folder monitoring
	. Device driver monitoring
	. Network traffic monitoring and analysis
	. DNS monitoring and resolution
	. API calls monitoring




a. Perform port monitoring using TCPView and CurrPorts

PS: You can identify the malware trying to access a particular port by installing port monitoring tools such as TCPView and CurrPorts.

TCPView: TCPView is a Windows program that shows the detailed listings of all the TCP and UDP endpoints on the system, including the local and remote addresses, and the state of the TCP connections. It provides a subset of the Netstat program that ships with Windows. The TCPView download includes Tcpvcon, a command-line version with the same functionality. When TCPView runs, it enumerates all active TCP and UDP endpoints, resolving all IP addresses to their domain name versions.

CurrPorts: CurrPorts is a piece of network monitoring software that displays a list of all the currently open TCP/IP and UDP ports on a local computer. For each port in the list, information about the process that opened the port is also displayed, including the process name, full path of the process, version information of the process (product name, file description, etc.), the time that the process was created, and the user that created it.

Launch njRAT -> Start -> Builder -> ExeName: Trojan.exe -> Build -> Save in ..\njRAT (Trojan.exe) -> 
Server 22 -> ..\njRAT Trojan.exe -> .\Port Monitoring Tools\TCPView Tcpview.exe -> Agree -> Local Port (view port in serial order) -> Search (Trojan.exe) -> Right-click -> (Kill Process) 
Server 22 -> ..\CurrPorts cports.exe -> (Shows list of currently open TCP/IP and UDP ports -> Scroll down to Trojan.exe -> Right-click:Properties -> Ok -> Right-click -> Kill Process ofSelected Ports/Close Selected TCP Connections 





b. Perform process monitoring using Process Monitor

Process Monitor is a monitoring tool for Windows that shows the real-time file system, Registry, and process and thread activity. It combines the features of two legacy Sysinternals utilities, Filemon and Regmon.

.\Dynamic..\Process Monitoring Tools\ProcessMonitor Procmon.exe -> Agree -> Right-click Trojan.exe -> Properties -> Event -> Process -> Stack (show DLLs) -> 




c. Perform registry monitoring using Reg Organizer

PS: The Windows Registry stores OS and program configuration details such as settings and options. If the malware is a program, the registry stores its functionality. When an attacker installs a type of malware on the victim’s machine, it generates a registry entry.

PS: Registry monitoring tools such as Reg Organizer provide a simple way to track registry modifications, which is useful in troubleshooting and monitoring background changes.

PS: Reg Organizer is designed to edit keys and parameters, as well as to delete the content of.reg files. It allows users to perform various operations with the system registry such as export, import and copy key values. It can also perform a deep searches to find even those keys associated with the application that cannot be found by other similar programs.


Step 1: Run Reg Organizer and Make a Snapshot of Registry Current State

..\Dynamic..\Resgistry..\Reg Organizer  reg-organizer-setup.exe -> (after install) uncheck Enable.. What'snew.. Finish -> Tools -> Registry Snapshots -> Create Snapshot -> Snapshot name: Shot 1 -> Ok

Step 2:Install Any Application

..Module 4..\SNMP..\SoftPerfect.. netscan_setup.exe

Step 3: Compare Registry 

Compare with Current Registry (compare the changes in the registry entries)






d. Perform Windows services monitoring using Windows Service Manager (SrvMan)

PS: Attackers design malware and other malicious code in such a way that they install and run on a computer device in the form of a service. As most services run in the background to support processes and applications, malicious services are invisible, even when they are performing harmful activities on the system, and can even function without intervention or input.

PS: Malware may also employ rootkit techniques to manipulate the following registry keys to hide their processes and services.
HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services These malicious services run as the SYSTEM account or another privileged account, which provides more access compared to regular user accounts, making them more dangerous than common malware and executable code. 

PS: You can trace malicious services initiated by the suspect file during dynamic analysis by using Windows service monitoring tools such as Windows Service Manager (SrvMan), which can detect changes in services and scan for suspicious Windows services.

..\Dynamic..\Windows Serv..\Windows Service Manager (SrvMan)\x64  srvman.exe -> View Properties/Start or Stop services/Delete Service/Restart Service/Add Service etc






e. Perform startup program monitoring using Autoruns for Windows and WinPatrol

PS: Startup programs are applications or processes that start when your system boots up. Attackers make many malicious programs such as Trojans and worms in such a way that they are executed during startup, and the user is unaware of the malicious program running in the background.

PS: Autoruns for Windows This utility can auto-start the location of any startup monitor, display which programs are configured to run during system bootup or login, and show the entries in the order Windows processes them. 

PS: WinPatrol WinPatrol provides the user with 14 different tabs to help in monitoring the system and its files. This security utility gives the user a chance to look for programs that are running in the background of a system so that the user can take a closer look and control the execution of legitimate and malicious programs.

..\Dynamic..\Windows..\Autorun for Windows  Autoruns.exe -> Agree -> Logon -> Explorer -> Services -> Drivers -> Known DLLs -> 

..\Dynamic..\Windows..\WinPatrol  wpsetup.exe -> Startup Programs -> IE Helpers -> Services/Info/Disabled/Apply/Close -> File Types -> Active Tasks -> 






f. Perform installation monitoring using Mirekusoft Install Monitor

PS: Mirekusoft Install Monitor automatically monitors what gets placed on your system and allows you to uninstall it completely. Install Monitor works by monitoring what resources such as file and registry, are created when a program is installed. It provides detailed information about the software installed, including how much disk space, CPU, and memory your programs are using.

..\Dynamc..\Installation..\Mirekusoft..   SetupInstallMonitor.exe -> SkipScan -> Programs (WinPatrol) -> Uninstall -> Performance -> Startup -> 






g. Perform files and folder monitoring using PA File Sight

PS: Malware can modify system files and folders to save information in them. You should be able to find the files and folders that malware creates and analyze them to collect any relevant stored information. These files and folders may also contain hidden program code or malicious strings that the malware plans to execute on a specific schedule.

PS: An ethical hacker or penetration tester must scan the system for suspicious files and folders using file and folder monitoring tools such as PA File Sight to detect any malware installed and any system file modifications. PA File Sight is a protection and auditing tool

Too long 






h. Perform device driver monitoring using DriverView and Driver Reviver

PS: DriverView The DriverView utility displays a list of all device drivers currently loaded on the system. For each driver in the list, additional information is displayed such as the load address of the driver, description, version, product name, and developer.

PS: Driver Reviver provides an effective way of scanning your PC to identify out of date drivers. Driver Reviver can quickly and easily update these drivers to restore optimum performance to your PC and its hardware and extend its life.

..\Dynamic..\Device Driver..\DriverView  DriverView.exe -> right-click a driver -> Properties -> Close

..\Dynamic..\Device Driver..\Driver Reviver  DriverReviverSetup.exe -> Home -> Backup 





i. Perform DNS monitoring using DNSQuerySniffer

PS: DNSQuerySniffer is a network sniffer utility that shows the DNS queries sent on your system. For every DNS query, the following information is displayed: Host Name, Port Number, Query ID, Request Type (A, AAAA, NS, MX, and other types), Request Time, Response Time, Duration, Response Code, Number of records, and the content of the returned DNS records.

..\Dynamic..\DNS..\DNSQuerySniffer  DNSQuerySniffer.exe -> Capture Options: WinPcap.. -> Ok -> Right-click Network -> Open Ntwk and Internet Settings -> Change Adapter Setting -> Right-click Ethernet -> Properties -> etc.









